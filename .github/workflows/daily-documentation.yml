name: Daily Test Documentation Generation

on:
  schedule:
    # Daily at 10:00 PM UTC
    - cron: '0 22 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all test entries'
        required: false
        type: boolean
        default: false

jobs:
  # Job 1: Split tests into batches
  prepare-batches:
    name: Prepare Test Batches
    runs-on: ubuntu-latest
    outputs:
      batch-count: ${{ steps.split.outputs.batch-count }}
      total-tests: ${{ steps.split.outputs.total-tests }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Split tests into batches
        id: split
        run: |
          echo "üìä Splitting tests into batches of 20%..."
          
          # Find all test files
          TEST_FILES=$(find tests -name "*.spec.js" -o -name "*.test.js" | sort)
          TOTAL_TESTS=$(echo "$TEST_FILES" | wc -l | tr -d ' ')
          
          echo "‚úÖ Found $TOTAL_TESTS test files"
          
          # Calculate batch size (20% of total, minimum 1)
          BATCH_SIZE=$(( ($TOTAL_TESTS * 20 + 99) / 100 ))
          if [ $BATCH_SIZE -lt 1 ]; then
            BATCH_SIZE=1
          fi
          
          # Calculate number of batches (5 batches for 100%)
          BATCH_COUNT=5
          
          echo "üì¶ Batch size: $BATCH_SIZE tests per batch"
          echo "üì¶ Number of batches: $BATCH_COUNT"
          
          # Create batch files
          mkdir -p batches
          BATCH_NUM=0
          COUNT=0
          
          for TEST_FILE in $TEST_FILES; do
            BATCH_FILE="batches/batch-${BATCH_NUM}.txt"
            echo "$TEST_FILE" >> "$BATCH_FILE"
            COUNT=$((COUNT + 1))
            
            if [ $COUNT -ge $BATCH_SIZE ]; then
              BATCH_NUM=$((BATCH_NUM + 1))
              COUNT=0
            fi
          done
          
          # Show batch distribution
          echo ""
          echo "üìã Batch distribution:"
          for i in $(seq 0 $((BATCH_COUNT - 1))); do
            if [ -f "batches/batch-${i}.txt" ]; then
              BATCH_TESTS=$(wc -l < "batches/batch-${i}.txt" | tr -d ' ')
              echo "   Batch $i: $BATCH_TESTS tests"
            fi
          done
          
          # Set outputs
          echo "batch-count=$BATCH_COUNT" >> $GITHUB_OUTPUT
          echo "total-tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT

      - name: Upload batch files
        uses: actions/upload-artifact@v4
        with:
          name: test-batches
          path: batches/
          retention-days: 1

  # Job 2: Process batches in parallel
  process-batch:
    name: Process Batch ${{ matrix.batch }}
    runs-on: ubuntu-latest
    needs: prepare-batches
    strategy:
      matrix:
        batch: [0, 1, 2, 3, 4]
      fail-fast: false # Continue even if one batch fails
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download batch files
        uses: actions/download-artifact@v4
        with:
          name: test-batches
          path: batches/

      - name: Process batch ${{ matrix.batch }} with AI
        id: process
        run: |
          echo "üì¶ Processing batch ${{ matrix.batch }} with AI analysis..."
          
          BATCH_FILE="batches/batch-${{ matrix.batch }}.txt"
          
          if [ ! -f "$BATCH_FILE" ]; then
            echo "‚ö†Ô∏è  Batch file not found: $BATCH_FILE"
            echo "   This batch is empty, skipping"
            echo "tests_processed=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Run AI-powered documentation generation for this batch
          OUTPUT=$(node scripts/ai-batch-processor.js "$BATCH_FILE" ${{ matrix.batch }} 2>&1)
          EXIT_CODE=$?
          
          echo "$OUTPUT"
          
          # Extract statistics
          TESTS_PROCESSED=$(echo "$OUTPUT" | grep -oP 'Tests processed: \K\d+' || echo "0")
          ENTRIES_GENERATED=$(echo "$OUTPUT" | grep -oP 'Entries generated: \K\d+' || echo "0")
          AI_SUCCESS=$(echo "$OUTPUT" | grep -oP 'AI analyses successful: \K\d+' || echo "0")
          
          echo "tests_processed=$TESTS_PROCESSED" >> $GITHUB_OUTPUT
          echo "entries_generated=$ENTRIES_GENERATED" >> $GITHUB_OUTPUT
          echo "ai_success=$AI_SUCCESS" >> $GITHUB_OUTPUT
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Batch processing failed"
            exit $EXIT_CODE
          fi
          
          echo "‚úÖ Batch ${{ matrix.batch }} completed: $ENTRIES_GENERATED entries (AI: $AI_SUCCESS)"
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_API_KEY_2: ${{ secrets.AI_API_KEY_2 }}
          AI_API_KEY_3: ${{ secrets.AI_API_KEY_3 }}
          AI_API_KEY_4: ${{ secrets.AI_API_KEY_4 }}
          AI_API_KEY_5: ${{ secrets.AI_API_KEY_5 }}
          AI_API_KEY_6: ${{ secrets.AI_API_KEY_6 }}
          AI_API_KEY_7: ${{ secrets.AI_API_KEY_7 }}
          AI_API_KEY_8: ${{ secrets.AI_API_KEY_8 }}

      - name: Upload batch documentation
        uses: actions/upload-artifact@v4
        with:
          name: batch-docs-${{ matrix.batch }}
          path: documentation/batch-${{ matrix.batch }}.json
          retention-days: 1

  # Job 3: Consolidate all batches and update Coda
  consolidate-and-update:
    name: Consolidate & Update Coda
    runs-on: ubuntu-latest
    needs: [prepare-batches, process-batch]
    if: always() # Run even if some batches fail
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download all batch documentation
        uses: actions/download-artifact@v4
        with:
          pattern: batch-docs-*
          path: documentation/batches/
          merge-multiple: true

      - name: Consolidate AI-generated documentation
        id: consolidate
        run: |
          echo "üìö Consolidating AI-generated documentation..."
          
          OUTPUT=$(node scripts/consolidate-ai-documentation.js 2>&1)
          EXIT_CODE=$?
          
          echo "$OUTPUT"
          
          # Extract statistics
          if echo "$OUTPUT" | grep -q "##CONSOLIDATE_STATS_START##"; then
            TOTAL_ENTRIES=$(echo "$OUTPUT" | sed -n '/##CONSOLIDATE_STATS_START##/,/##CONSOLIDATE_STATS_END##/p' | grep "TOTAL_ENTRIES:" | cut -d: -f2 | tr -d ' ')
            BATCHES_PROCESSED=$(echo "$OUTPUT" | sed -n '/##CONSOLIDATE_STATS_START##/,/##CONSOLIDATE_STATS_END##/p' | grep "BATCHES_PROCESSED:" | cut -d: -f2 | tr -d ' ')
          else
            TOTAL_ENTRIES=$(echo "$OUTPUT" | grep -oP 'Total entries: \K\d+' || echo "0")
            BATCHES_PROCESSED=$(echo "$OUTPUT" | grep -oP 'Batches processed: \K\d+' || echo "0")
          fi
          
          echo "total_entries=$TOTAL_ENTRIES" >> $GITHUB_OUTPUT
          echo "batches_processed=$BATCHES_PROCESSED" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Consolidation failed"
            exit $EXIT_CODE
          fi
          
          echo "‚úÖ Consolidated $TOTAL_ENTRIES entries from $BATCHES_PROCESSED batches"

      - name: Update Coda page
        id: update-coda
        run: |
          echo "üì§ Updating Coda page..."
          
          set +e  # Don't exit on error
          node scripts/update-coda-page.js
          EXIT_CODE=$?
          set -e
          
          echo ""
          echo "üìä Exit code: $EXIT_CODE"
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Coda update failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi
          
          echo "‚úÖ Coda page updated successfully"
        env:
          CODA_API_TOKEN: ${{ secrets.CODA_API_TOKEN }}
          CODA_DOC_ID: ${{ secrets.CODA_DOC_ID || 'dza2s1eOIhA' }}
          CODA_PAGE_ID: ${{ secrets.CODA_PAGE_ID || 'suLCLolD' }}

      - name: Send Slack notification
        if: always()
        run: |
          echo "üì§ Sending Slack notification..."
          
          # Determine status
          if [ "${{ steps.consolidate.outputs.exit_code }}" == "0" ] && [ "${{ steps.update-coda.conclusion }}" == "success" ]; then
            STATUS="‚úÖ Success"
            EMOJI="‚úÖ"
          else
            STATUS="‚ùå Failed"
            EMOJI="‚ùå"
          fi
          
          # Build summary
          SUMMARY="*Total Entries:* ${{ steps.consolidate.outputs.total_entries }}\n"
          SUMMARY="${SUMMARY}*Batches Processed:* ${{ steps.consolidate.outputs.batches_processed }}\n"
          SUMMARY="${SUMMARY}*Total Tests:* ${{ needs.prepare-batches.outputs.total-tests }}\n"
          SUMMARY="${SUMMARY}*Coda Page:* <https://coda.io/d/${CODA_DOC_ID}/_${CODA_PAGE_ID}|View Documentation>"
          
          # Create Slack payload
          PAYLOAD=$(cat <<EOF
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${EMOJI} Daily Test Documentation Update"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Status:*\n${STATUS}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Workflow:*\n<${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|#${GITHUB_RUN_NUMBER}>"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Summary:*\n${SUMMARY}"
                }
              }
            ]
          }
          EOF
          )
          
          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL"
          
          echo "‚úÖ Slack notification sent"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          CODA_DOC_ID: ${{ secrets.CODA_DOC_ID || 'dza2s1eOIhA' }}
          CODA_PAGE_ID: ${{ secrets.CODA_PAGE_ID || 'suLCLolD' }}
