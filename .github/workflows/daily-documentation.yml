name: Daily Test Documentation Generation

on:
  schedule:
    # Daily at 10:00 PM UTC
    - cron: '0 22 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all test entries'
        required: false
        type: boolean
        default: false

jobs:
  update-coda-documentation:
    name: Update Coda Test Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install QODO CLI
        run: npm install -g @qodo/command

      - name: Authenticate QODO
        run: |
          mkdir -p ~/.qodo
          echo "${{ secrets.QODO_API_KEY }}" > ~/.qodo/api_key

      - name: Update Coda documentation
        id: update-coda
        run: |
          echo "üìö Starting Coda documentation update..."
          
          # Run the update script and capture output
          set +e  # Don't exit on error immediately
          OUTPUT=$(node scripts/update-coda-documentation.js 2>&1)
          EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          # Save output for debugging
          echo "$OUTPUT" > coda_update_output.log
          echo "$OUTPUT"
          
          # If script failed, show more details
          if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "‚ùå Script failed with exit code: $EXIT_CODE"
            echo "üìã Full error output:"
            echo "$OUTPUT"
          fi
          
          # Extract statistics from structured output
          if echo "$OUTPUT" | grep -q "##CODA_STATS_START##"; then
            NEW_ENTRIES=$(echo "$OUTPUT" | sed -n '/##CODA_STATS_START##/,/##CODA_STATS_END##/p' | grep "NEW_ENTRIES:" | cut -d: -f2 | tr -d ' ')
            UPDATED_ENTRIES=$(echo "$OUTPUT" | sed -n '/##CODA_STATS_START##/,/##CODA_STATS_END##/p' | grep "UPDATED_ENTRIES:" | cut -d: -f2 | tr -d ' ')
            TOTAL_ENTRIES=$(echo "$OUTPUT" | sed -n '/##CODA_STATS_START##/,/##CODA_STATS_END##/p' | grep "TOTAL_ENTRIES:" | cut -d: -f2 | tr -d ' ')
            ERRORS=$(echo "$OUTPUT" | sed -n '/##CODA_STATS_START##/,/##CODA_STATS_END##/p' | grep "ERRORS:" | cut -d: -f2 | tr -d ' ')
          else
            # Fallback parsing
            NEW_ENTRIES=$(echo "$OUTPUT" | grep -oP 'New entries: \K\d+' || echo "0")
            UPDATED_ENTRIES=$(echo "$OUTPUT" | grep -oP 'Updated entries: \K\d+' || echo "0")
            TOTAL_ENTRIES=$(echo "$OUTPUT" | grep -oP 'Total entries: \K\d+' || echo "0")
            ERRORS=$(echo "$OUTPUT" | grep -oP 'Errors: \K\d+' || echo "0")
          fi
          
          # Set output variables
          echo "new_entries=$NEW_ENTRIES" >> $GITHUB_OUTPUT
          echo "updated_entries=$UPDATED_ENTRIES" >> $GITHUB_OUTPUT
          echo "total_entries=$TOTAL_ENTRIES" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Display summary
          echo ""
          echo "üìä Coda Documentation Update Summary:"
          echo "   - New Entries: $NEW_ENTRIES"
          echo "   - Updated Entries: $UPDATED_ENTRIES"
          echo "   - Total Entries: $TOTAL_ENTRIES"
          echo "   - Errors: $ERRORS"
          echo "   - Exit Code: $EXIT_CODE"
          echo ""
          
          # Exit with the script's exit code
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Coda documentation update failed"
            exit $EXIT_CODE
          fi
          
          echo "‚úÖ Coda documentation updated successfully"
        env:
          CODA_API_TOKEN: ${{ secrets.CODA_API_TOKEN }}
          CODA_DOC_ID: ${{ secrets.CODA_DOC_ID || 'dza2s1eOIhA' }}
          CODA_PAGE_ID: ${{ secrets.CODA_PAGE_ID || 'suLCLolD' }}
          QODO_API_KEY: ${{ secrets.QODO_API_KEY }}
          QODO_API_URL: ${{ secrets.QODO_API_URL || 'https://api.qodo.ai/v1/chat/completions' }}

      - name: Send Slack notification
        if: always()
        run: |
          echo "üì§ Sending Slack notification..."
          
          # Determine status and color
          if [ "${{ steps.update-coda.outputs.exit_code }}" == "0" ]; then
            STATUS="‚úÖ Success"
            COLOR="good"
            EMOJI="‚úÖ"
          else
            STATUS="‚ùå Failed"
            COLOR="danger"
            EMOJI="‚ùå"
          fi
          
          # Build summary message
          SUMMARY="*New Entries:* ${{ steps.update-coda.outputs.new_entries }}\n"
          SUMMARY="${SUMMARY}*Updated Entries:* ${{ steps.update-coda.outputs.updated_entries }}\n"
          SUMMARY="${SUMMARY}*Total Entries:* ${{ steps.update-coda.outputs.total_entries }}\n"
          SUMMARY="${SUMMARY}*Errors:* ${{ steps.update-coda.outputs.errors }}\n"
          SUMMARY="${SUMMARY}*Coda Page:* <https://coda.io/d/${CODA_DOC_ID}/_${CODA_PAGE_ID}|View Documentation>"
          
          # Create Slack message payload
          PAYLOAD=$(cat <<EOF
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${EMOJI} Daily Test Documentation Update"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Status:*\n${STATUS}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Workflow Run:*\n<${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|#${GITHUB_RUN_NUMBER}>"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Repository:*\n${GITHUB_REPOSITORY}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Triggered By:*\n${GITHUB_ACTOR}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Summary:*\n${SUMMARY}"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Workflow:*\n<${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/workflows/daily-documentation.yml|View Workflow>"
                }
              }
            ]
          }
          EOF
          )
          
          # Send to Slack
          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL"
          
          echo "‚úÖ Slack notification sent"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_ACTOR: ${{ github.actor }}
          CODA_DOC_ID: ${{ secrets.CODA_DOC_ID || 'dza2s1eOIhA' }}
          CODA_PAGE_ID: ${{ secrets.CODA_PAGE_ID || 'suLCLolD' }}

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coda-update-logs
          path: |
            coda_update_output.log
          retention-days: 30
