# ==============================================================================
# UI TEST DOCUMENTATION WORKFLOW
# ==============================================================================
name: UI Test Documentation

# ==============================================================================
# TRIGGERS
# ==============================================================================
on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:  # Manual trigger option

# ==============================================================================
# JOBS
# ==============================================================================
jobs:
  # ==========================================================================
  # JOB: DETECT CHANGES (New or Modified Tests)
  # ==========================================================================
  prepare:
    name: 1Ô∏è‚É£ Detect New & Changed Tests
    runs-on: ubuntu-latest
    outputs:
      tests-to-process: ${{ steps.detect.outputs.tests-to-process }}
      skip-processing: ${{ steps.detect.outputs.skip-processing }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - run: npm install
      
      - name: Download metadata from previous run
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: test-documentation.yml
          name: test-metadata
          path: documentation/
          if_no_artifact_found: ignore
      
      - name: Detect new or changed tests
        id: detect
        run: |
          node auto_documentator/scripts/detect-changes.mjs | tee detect-output.txt
          
          TESTS=$(grep "tests-to-process=" detect-output.txt | cut -d= -f2 || echo "0")
          echo "tests-to-process=$TESTS" >> $GITHUB_OUTPUT
          
          if [ "$TESTS" -eq 0 ]; then
            echo "skip-processing=true" >> $GITHUB_OUTPUT
            echo "‚úÖ No changes - skipping AI processing"
          else
            echo "skip-processing=false" >> $GITHUB_OUTPUT
            echo "üöÄ Will process $TESTS test(s)"
          fi
      
      - uses: actions/upload-artifact@v4
        if: steps.detect.outputs.skip-processing != 'true'
        with:
          name: tests-to-process
          path: documentation/tests-to-process.txt
          retention-days: 1

  # ==========================================================================
  # JOB: AI ANALYSIS (Process new/changed tests with 100% success providers)
  # ==========================================================================
  analyze:
    name: 2Ô∏è‚É£ Phase 1 - Batch ${{ matrix.batch }}
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.skip-processing != 'true'
    strategy:
      matrix:
        batch: [0, 1]  # Only 2 batches - OR-Llama-70B and OR-Gemma-27B
      fail-fast: false
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      - uses: actions/download-artifact@v4
        with:
          name: tests-to-process
          path: documentation/
      
      - name: Split tests for this batch
        run: |
          # Read tests to process
          TESTS=$(cat documentation/tests-to-process.txt)
          TOTAL=$(echo "$TESTS" | wc -l | tr -d ' ')
          
          # Distribute using modulo (batch 0 gets even indices, batch 1 gets odd)
          INDEX=0
          > "my-tests.txt"
          echo "$TESTS" | while read -r FILE; do
            if [ -n "$FILE" ]; then
              if [ $((INDEX % 2)) -eq ${{ matrix.batch }} ]; then
                echo "$FILE" >> "my-tests.txt"
              fi
              INDEX=$((INDEX + 1))
            fi
          done
          
          MY_COUNT=$(wc -l < "my-tests.txt" | tr -d ' ')
          echo "üì¶ Batch ${{ matrix.batch }}: $MY_COUNT tests to process"
      
      - name: Process with proven provider (20s between tests)
        run: |
          PROVIDER_NAME=$([ "${{ matrix.batch }}" -eq 0 ] && echo "OR-Llama-70B (100%)" || echo "OR-Gemma-27B (100%)")
          echo "üéØ Batch ${{ matrix.batch }} - $PROVIDER_NAME"
          echo "‚è±Ô∏è  20 second delays between tests"
          
          # Create a simple script to process tests from my-tests.txt
          node auto_documentator/scripts/overnight-processor.mjs ${{ matrix.batch }}
        timeout-minutes: 120
        env:
          AI_API_KEY_5: ${{ secrets.AI_API_KEY_5 }}
      
      - uses: actions/upload-artifact@v4
        with:
          name: batch-docs-${{ matrix.batch }}
          path: documentation/batch-${{ matrix.batch }}.json
          retention-days: 7

  # ==========================================================================
  # JOB: ANALYZE RESULTS (Identify failures and working providers)
  # ==========================================================================
  analyze-results:
    name: 3Ô∏è‚É£ Analyze Phase 1 Results
    runs-on: ubuntu-latest
    needs: [prepare, analyze]
    if: always() && needs.prepare.outputs.skip-processing != 'true'
    outputs:
      failed-count: ${{ steps.analyze.outputs.failed-count }}
      working-batches: ${{ steps.analyze.outputs.working-batches }}
      needs-retry: ${{ steps.analyze.outputs.needs-retry }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - run: npm ci
      
      - uses: actions/download-artifact@v4
        with:
          pattern: batch-docs-*
          path: documentation/
          merge-multiple: true
      
      - name: Identify failures and working providers
        id: analyze
        run: |
          OUTPUT=$(node auto_documentator/scripts/identify-failures.mjs | tee analysis.txt)
          echo "$OUTPUT"
          
          FAILED=$(grep "failed-count=" analysis.txt | cut -d= -f2 || echo "0")
          WORKING=$(grep "working-batches=" analysis.txt | cut -d= -f2 || echo "")
          
          echo "failed-count=$FAILED" >> $GITHUB_OUTPUT
          echo "working-batches=$WORKING" >> $GITHUB_OUTPUT
          
          if [ "$FAILED" -gt 0 ] && [ -n "$WORKING" ]; then
            echo "needs-retry=true" >> $GITHUB_OUTPUT
            echo "üîÑ Will retry $FAILED tests with working providers: $WORKING"
          else
            echo "needs-retry=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No retry needed"
          fi
      
      - uses: actions/upload-artifact@v4
        if: steps.analyze.outputs.needs-retry == 'true'
        with:
          name: retry-data
          path: |
            documentation/failed-tests.txt
            documentation/batch-stats.json
          retention-days: 1

  # ==========================================================================
  # JOB: RECOVERY (Retry failed tests with proven working providers)
  # ==========================================================================
  retry:
    name: 4Ô∏è‚É£ Retry with Batch ${{ matrix.working-batch }}
    runs-on: ubuntu-latest
    needs: analyze-results
    if: needs.analyze-results.outputs.needs-retry == 'true'
    strategy:
      matrix:
        working-batch: ${{ fromJson(format('[{0}]', needs.analyze-results.outputs.working-batches)) }}
      fail-fast: false
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - run: npm ci
      
      - uses: actions/download-artifact@v4
        with:
          name: retry-data
          path: documentation/
      
      - name: Retry failed tests (1 minute delays - STRICT)
        run: |
          echo "üîÑ Retrying with working provider from Batch ${{ matrix.working-batch }}"
          echo "‚è±Ô∏è  STRICT 1 MINUTE between tests"
          node auto_documentator/scripts/retry-with-working-providers.mjs ${{ matrix.working-batch }}
        timeout-minutes: 360
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_API_KEY_2: ${{ secrets.AI_API_KEY_2 }}
          AI_API_KEY_5: ${{ secrets.AI_API_KEY_5 }}
          AI_API_KEY_6: ${{ secrets.AI_API_KEY_6 }}
          AI_API_KEY_7: ${{ secrets.AI_API_KEY_7 }}
      
      - uses: actions/upload-artifact@v4
        with:
          name: retry-docs-${{ matrix.working-batch }}
          path: documentation/batch-retry-${{ matrix.working-batch }}.json
          retention-days: 7

  # ==========================================================================
  # JOB: CONSOLIDATION (Merge all results and update metadata)
  # ==========================================================================
  consolidate:
    name: 5Ô∏è‚É£ Final Consolidation
    runs-on: ubuntu-latest
    needs: [prepare, analyze, analyze-results, retry]
    if: always() && needs.prepare.outputs.skip-processing != 'true'
    outputs:
      total-entries: ${{ steps.consolidate.outputs.total }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - run: npm ci
      
      - uses: actions/download-artifact@v4
        with:
          pattern: batch-docs-*
          path: documentation/
          merge-multiple: true
      
      - uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: retry-docs-*
          path: documentation/
          merge-multiple: true
      
      - name: Merge all documentation
        id: consolidate
        run: |
          OUTPUT=$(node auto_documentator/scripts/merge-documentation.mjs 2>&1)
          echo "$OUTPUT"
          
          TOTAL=$(echo "$OUTPUT" | grep -oP 'TOTAL_ENTRIES:\K\d+' || echo "0")
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "‚úÖ Final documentation: $TOTAL entries"
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GIT_USER_NAME: ${{ github.event.pusher.name || github.actor }}
      
      - name: Create simple header
        run: |
          echo "All batches processed - merging results"
      
      - uses: actions/upload-artifact@v4
        with:
          name: consolidated-docs
          path: documentation/CONSOLIDATED_DOCUMENTATION.md
          retention-days: 7
      
      - uses: actions/upload-artifact@v4
        with:
          name: existing-docs
          path: documentation/EXISTING_DOCUMENTATION.md
          retention-days: 365  # Keep for incremental updates
      
      - name: Update metadata for processed tests
        run: |
          echo "üíæ Updating metadata..."
          node auto_documentator/scripts/update-metadata.mjs
      
      - uses: actions/upload-artifact@v4
        with:
          name: test-metadata
          path: documentation/test-metadata.json
          retention-days: 365  # Keep metadata for a year

  # ==========================================================================
  # JOB: UPDATE CODA (Parallel with Notion)
  # ==========================================================================
  update-coda:
    name: 6Ô∏è‚É£ A Update Coda
    runs-on: ubuntu-latest
    needs: consolidate
    if: needs.consolidate.outputs.total-entries > 0
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      - uses: actions/download-artifact@v4
        with:
          name: consolidated-docs
          path: documentation/
      
      - name: Update Coda page
        run: node auto_documentator/scripts/update-coda-page.mjs
        env:
          CODA_API_TOKEN: ${{ secrets.CODA_API_TOKEN }}
          CODA_DOC_ID: ${{ secrets.CODA_DOC_ID || 'dza2s1eOIhA' }}
          CODA_PAGE_ID: ${{ secrets.CODA_PAGE_ID || 'suLCLolD' }}

  # ==========================================================================
  # JOB: UPDATE NOTION (Parallel with Coda)
  # ==========================================================================
  update-notion:
    name: 6Ô∏è‚É£ B Update Notion
    runs-on: ubuntu-latest
    needs: consolidate
    if: needs.consolidate.outputs.total-entries > 0
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      - uses: actions/download-artifact@v4
        with:
          name: consolidated-docs
          path: documentation/
      
      - name: Update Notion page
        run: node auto_documentator/scripts/update-notion-page.mjs
        env:
          NOTION_SECRET: ${{ secrets.NOTION_SECRET }}
          NOTION_PAGE_ID: '2bdd92a99cff809e98ddcec14e6b7bdc'

  # ==========================================================================
  # JOB: NOTIFICATION (Slack notification with results)
  # ==========================================================================
  notify:
    name: 7Ô∏è‚É£ Notify
    runs-on: ubuntu-latest
    needs: [consolidate, update-coda, update-notion]
    if: always()
    
    steps:
      - name: Send Slack notification
        run: |
          CODA_STATUS="${{ needs.update-coda.result }}"
          NOTION_STATUS="${{ needs.update-notion.result }}"
          
          if [ "$CODA_STATUS" == "success" ] && [ "$NOTION_STATUS" == "success" ]; then
            EMOJI="‚úÖ"
            STATUS="Success"
          elif [ "$CODA_STATUS" == "success" ] || [ "$NOTION_STATUS" == "success" ]; then
            EMOJI="‚ö†Ô∏è"
            STATUS="Partial Success"
          else
            EMOJI="‚ùå"
            STATUS="Failed"
          fi
          
          SUMMARY="*UI Test Files:* ${{ needs.consolidate.outputs.total-entries }}\n"
          SUMMARY="${SUMMARY}*UI Test Cases:* 61 individual tests\n"
          SUMMARY="${SUMMARY}*Coda:* $([ "$CODA_STATUS" == "success" ] && echo "‚úÖ" || echo "‚ùå")\n"
          SUMMARY="${SUMMARY}*Notion:* $([ "$NOTION_STATUS" == "success" ] && echo "‚úÖ" || echo "‚ùå")\n"
          SUMMARY="${SUMMARY}\n*Links:*\n"
          SUMMARY="${SUMMARY}‚Ä¢ <https://coda.io/d/dza2s1eOIhA/_suLCLolD|Coda UI Tests>\n"
          SUMMARY="${SUMMARY}‚Ä¢ <https://www.notion.so/2bdd92a99cff809e98ddcec14e6b7bdc|Notion UI Tests>"
          
          curl -X POST -H 'Content-type: application/json' --data '{
            "blocks": [
              {
                "type": "header",
                "text": {"type": "plain_text", "text": "'"${EMOJI} UI Test Documentation - ${STATUS}"'"}
              },
              {
                "type": "section",
                "text": {"type": "mrkdwn", "text": "'"${SUMMARY}"'"}
              },
              {
                "type": "context",
                "elements": [{"type": "mrkdwn", "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"}]
              }
            ]
          }' "${{ secrets.SLACK_WEBHOOK_URL }}"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}


