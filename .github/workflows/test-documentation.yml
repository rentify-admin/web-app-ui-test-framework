name: Test Documentation

on:
  schedule:
    - cron: '0 22 * * *'  # Daily at 10 PM UTC
  push:
    branches:
      - master
      - main
      - feature/daily-documentation-workflow
  workflow_dispatch:

jobs:
  # Job 1: Detect changes and prepare batches
  prepare:
    name: 1ï¸âƒ£ Detect Changes & Prepare
    runs-on: ubuntu-latest
    outputs:
      total-tests: ${{ steps.detect.outputs.total-tests }}
      tests-to-process: ${{ steps.detect.outputs.tests-to-process }}
      skip-processing: ${{ steps.detect.outputs.skip-processing }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for metadata
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Fetch Coda and find documentation gaps
        id: detect
        run: |
          node auto_documentator/scripts/fetch-coda-and-find-gaps.js | tee gap-analysis.txt
          
          TESTS_TO_PROCESS=$(grep "tests-to-process=" gap-analysis.txt | cut -d= -f2)
          echo "tests-to-process=$TESTS_TO_PROCESS" >> $GITHUB_OUTPUT
          
          if [ "$TESTS_TO_PROCESS" -eq 0 ]; then
            echo "skip-processing=true" >> $GITHUB_OUTPUT
            echo "total-tests=0" >> $GITHUB_OUTPUT
          else
            echo "skip-processing=false" >> $GITHUB_OUTPUT
            echo "total-tests=$TESTS_TO_PROCESS" >> $GITHUB_OUTPUT
          fi
        env:
          CODA_API_TOKEN: ${{ secrets.CODA_API_TOKEN }}
      
      - name: Adaptive batching (optimal for workload)
        if: steps.detect.outputs.skip-processing != 'true'
        id: split
        run: |
          TEST_FILES=$(cat documentation/tests-to-process.txt)
          TOTAL=$(echo "$TEST_FILES" | wc -l | tr -d ' ')
          
          # Adaptive: Use fewer batches for smaller workloads
          if [ "$TOTAL" -le 7 ]; then
            NUM_BATCHES=$TOTAL
          elif [ "$TOTAL" -le 20 ]; then
            NUM_BATCHES=4
          else
            NUM_BATCHES=7
          fi
          
          echo "âœ… $TOTAL missing tests â†’ $NUM_BATCHES batches (adaptive)"
          echo "num-batches=$NUM_BATCHES" >> $GITHUB_OUTPUT
          
          mkdir -p batches
          
          # Initialize batch files
          i=0
          while [ $i -lt $NUM_BATCHES ]; do
            > "batches/batch-${i}.txt"
            i=$((i + 1))
          done
          
          # Distribute tests - write directly, avoid while subshell
          INDEX=0
          for FILE in $TEST_FILES; do
            if [ -n "$FILE" ]; then
              BATCH=$((INDEX % NUM_BATCHES))
              echo "$FILE" >> "batches/batch-${BATCH}.txt"
              INDEX=$((INDEX + 1))
            fi
          done
          
          # Show distribution
          echo ""
          echo "ğŸ“Š Adaptive batch distribution:"
          i=0
          while [ $i -lt $NUM_BATCHES ]; do
            COUNT=$(wc -l < "batches/batch-${i}.txt" 2>/dev/null | tr -d ' ' || echo "0")
            echo "   Batch $i: $COUNT tests"
            i=$((i + 1))
          done

      - uses: actions/upload-artifact@v4
        with:
          name: test-batches
          path: |
            batches/
            documentation/CODA_CURRENT.md
            documentation/tests-to-process.txt
          retention-days: 1

  # Job 2: Process batches with AI (parallel, 1 provider per batch)
  # OpenRouter with credits: 1000 req/day, 20 RPM
  analyze:
    name: 2ï¸âƒ£ AI Batch ${{ matrix.batch }}
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.skip-processing != 'true'
    strategy:
      matrix:
        batch: [0, 1, 2, 3, 4, 5, 6]
      fail-fast: false
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      - uses: actions/download-artifact@v4
        with:
          name: test-batches
          path: batches/
      
      - name: Run AI analysis (multi-provider retry for max success)
        run: |
          echo "ğŸ¤– Batch ${{ matrix.batch }} - Multi-provider retry mode"
          node auto_documentator/scripts/ai-analyzer-multi-retry.js "batches/batch-${{ matrix.batch }}.txt" ${{ matrix.batch }}
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_API_KEY_2: ${{ secrets.AI_API_KEY_2 }}
          AI_API_KEY_5: ${{ secrets.AI_API_KEY_5 }}
          AI_API_KEY_6: ${{ secrets.AI_API_KEY_6 }}
          AI_API_KEY_7: ${{ secrets.AI_API_KEY_7 }}
      
      - uses: actions/upload-artifact@v4
        with:
          name: batch-docs-${{ matrix.batch }}
          path: documentation/batch-${{ matrix.batch }}.json
          retention-days: 1

  # Job 3: Consolidate results & update metadata
  consolidate:
    name: 3ï¸âƒ£ Consolidate & Update Metadata
    runs-on: ubuntu-latest
    needs: [prepare, analyze]
    if: always() && needs.prepare.outputs.skip-processing != 'true'
    outputs:
      total-entries: ${{ steps.consolidate.outputs.total }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      - uses: actions/download-artifact@v4
        with:
          pattern: batch-docs-*
          path: documentation/batches/
          merge-multiple: true
      
      - name: Merge documentation (smart update)
        id: consolidate
        run: |
          OUTPUT=$(node auto_documentator/scripts/merge-documentation.js 2>&1)
          echo "$OUTPUT"
          
          TOTAL=$(echo "$OUTPUT" | grep -oP 'TOTAL_ENTRIES:\K\d+' || echo "0")
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "âœ… Final documentation: $TOTAL entries"
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GIT_USER_NAME: ${{ github.event.pusher.name || github.actor }}
      
      - name: Download Coda backup (from prepare job)
        uses: actions/download-artifact@v4
        with:
          name: test-batches
          path: documentation/
      
      - uses: actions/upload-artifact@v4
        with:
          name: consolidated-docs
          path: documentation/CONSOLIDATED_DOCUMENTATION.md
          retention-days: 7
      
      - uses: actions/upload-artifact@v4
        with:
          name: existing-docs
          path: documentation/EXISTING_DOCUMENTATION.md
          retention-days: 365  # Keep for incremental updates
      
      - uses: actions/upload-artifact@v4
        with:
          name: test-metadata
          path: documentation/test-metadata.json
          retention-days: 365  # Keep metadata for a year

  # Job 4A: Update Coda (parallel with Notion)
  update-coda:
    name: 4ï¸âƒ£ A Update Coda
    runs-on: ubuntu-latest
    needs: consolidate
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      - uses: actions/download-artifact@v4
        with:
          name: consolidated-docs
          path: documentation/
      
      - name: Update Coda page
        run: node auto_documentator/scripts/update-coda-page.js
        env:
          CODA_API_TOKEN: ${{ secrets.CODA_API_TOKEN }}
          CODA_DOC_ID: ${{ secrets.CODA_DOC_ID || 'dza2s1eOIhA' }}
          CODA_PAGE_ID: ${{ secrets.CODA_PAGE_ID || 'suLCLolD' }}

  # Job 4B: Update Notion (parallel with Coda)
  update-notion:
    name: 4ï¸âƒ£ B Update Notion
    runs-on: ubuntu-latest
    needs: consolidate
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      - uses: actions/download-artifact@v4
        with:
          name: consolidated-docs
          path: documentation/
      
      - name: Update Notion page
        run: node auto_documentator/scripts/update-notion-page.js
        env:
          NOTION_SECRET: ${{ secrets.NOTION_SECRET }}
          NOTION_PAGE_ID: '2bdd92a99cff809e98ddcec14e6b7bdc'

  # Job 5: Skip notification (when no processing needed)
  skip-notify:
    name: â­ï¸  No Changes Detected
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.skip-processing == 'true'
    
    steps:
      - name: All tests up to date
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All tests are already documented!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "No new or changed tests detected."
          echo "Documentation is up to date."
          echo ""
          echo "Skipping AI processing, Coda & Notion updates."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Job 6: Send notification
  notify:
    name: 6ï¸âƒ£ Notify
    runs-on: ubuntu-latest
    needs: [prepare, consolidate, update-coda, update-notion]
    if: always() && needs.prepare.outputs.skip-processing != 'true'
    
    steps:
      - name: Send Slack notification
        run: |
          CODA_STATUS="${{ needs.update-coda.result }}"
          NOTION_STATUS="${{ needs.update-notion.result }}"
          
          if [ "$CODA_STATUS" == "success" ] && [ "$NOTION_STATUS" == "success" ]; then
            EMOJI="âœ…"
            STATUS="Success"
          elif [ "$CODA_STATUS" == "success" ] || [ "$NOTION_STATUS" == "success" ]; then
            EMOJI="âš ï¸"
            STATUS="Partial Success"
          else
            EMOJI="âŒ"
            STATUS="Failed"
          fi
          
          SUMMARY="*Tests:* ${{ needs.prepare.outputs.total-tests }}\n"
          SUMMARY="${SUMMARY}*Entries:* ${{ needs.consolidate.outputs.total-entries }}\n"
          SUMMARY="${SUMMARY}*Coda:* $([ "$CODA_STATUS" == "success" ] && echo "âœ…" || echo "âŒ")\n"
          SUMMARY="${SUMMARY}*Notion:* $([ "$NOTION_STATUS" == "success" ] && echo "âœ…" || echo "âŒ")\n"
          SUMMARY="${SUMMARY}\n*Links:*\n"
          SUMMARY="${SUMMARY}â€¢ <https://coda.io/d/dza2s1eOIhA/_suLCLolD|Coda Docs>\n"
          SUMMARY="${SUMMARY}â€¢ <https://www.notion.so/2bdd92a99cff809e98ddcec14e6b7bdc|Notion Docs>"
          
          curl -X POST -H 'Content-type: application/json' --data '{
            "blocks": [
              {
                "type": "header",
                "text": {"type": "plain_text", "text": "'"${EMOJI} Test Documentation - ${STATUS}"'"}
              },
              {
                "type": "section",
                "text": {"type": "mrkdwn", "text": "'"${SUMMARY}"'"}
              },
              {
                "type": "context",
                "elements": [{"type": "mrkdwn", "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"}]
              }
            ]
          }' "${{ secrets.SLACK_WEBHOOK_URL }}"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

